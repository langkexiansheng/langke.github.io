{"title":"常见漏洞","slug":"常见漏洞","date":"2019-02-05T03:33:31.000Z","updated":"2019-02-06T09:36:13.349Z","comments":true,"path":"api/articles/常见漏洞.json","photos":[],"link":"","excerpt":"常见漏洞命令注入","covers":["https://bj.bcebos.com/v1/image-langke/hexo-neirongpeitu/PHP代码审计/php_命令注入.png","https://bj.bcebos.com/v1/image-langke/hexo-neirongpeitu/PHP代码审计/php_安装问题.png","https://bj.bcebos.com/v1/image-langke/hexo-neirongpeitu/PHP代码审计/php_sql注入.png","https://bj.bcebos.com/v1/image-langke/hexo-neirongpeitu/PHP代码审计/php_sql_思路展现.png","https://bj.bcebos.com/v1/image-langke/hexo-neirongpeitu/PHP代码审计/php_xss.png","https://bj.bcebos.com/v1/image-langke/hexo-neirongpeitu/PHP代码审计/php_文件上传.png","https://bj.bcebos.com/v1/image-langke/hexo-neirongpeitu/PHP代码审计/php_upload_时间戳.png","https://bj.bcebos.com/v1/image-langke/hexo-neirongpeitu/PHP代码审计/php_upload_思路展现.png","https://bj.bcebos.com/v1/image-langke/hexo-neirongpeitu/PHP代码审计/php_read_.png","https://bj.bcebos.com/v1/image-langke/hexo-neirongpeitu/PHP代码审计/php_read_思路展现.png","https://bj.bcebos.com/v1/image-langke/hexo-neirongpeitu/PHP代码审计/php_越权_思路.png"],"content":"<h1 id=\"常见漏洞\"><a href=\"#常见漏洞\" class=\"headerlink\" title=\"常见漏洞\"></a>常见漏洞</h1><h2 id=\"命令注入\"><a href=\"#命令注入\" class=\"headerlink\" title=\"命令注入\"></a>命令注入</h2><a id=\"more\"></a>\n<p><img src=\"https://bj.bcebos.com/v1/image-langke/hexo-neirongpeitu/PHP代码审计/php_命令注入.png\" alt=\"\"></p>\n<p><strong>注入即是通过利用无验证变量构造特殊语句对服务器进行渗透</strong></p>\n<blockquote>\n<p>注入的种类有很多，而不仅仅只有SQL Injection</p>\n</blockquote>\n<ul>\n<li>命令注入（Command Injection）</li>\n<li>Eval 注入（Eval Injection）</li>\n<li>客户端脚本攻击（Cross Site Scription, XSS）</li>\n<li>SQL注入攻击（SQL injection）</li>\n<li>动态函数注入攻击（Dynamic Variable Evaluation）</li>\n<li>序列化注入 &amp; 对象注入</li>\n</ul>\n<blockquote>\n<p>PHP中可以使用下列5个函数来执行外部的应用程序或函数（当然、能实现这样的功能的手段不只有这5个函数）</p>\n</blockquote>\n<ul>\n<li>system()</li>\n<li>exec()</li>\n<li>passthru()</li>\n<li>shell_exec()</li>\n<li>``(与shell_exec功能相同) </li>\n</ul>\n<blockquote>\n<p>思路扩展</p>\n</blockquote>\n<ul>\n<li>shell_exec</li>\n<li>搜索、在ping.php中找到</li>\n<li>$target=$_POST[‘target’];</li>\n<li>拼接 $cmd</li>\n<li>执行shell_exec($cmd)</li>\n</ul>\n<h2 id=\"安装问题的审计\"><a href=\"#安装问题的审计\" class=\"headerlink\" title=\"安装问题的审计\"></a>安装问题的审计</h2><blockquote>\n<p>一般PHP程序都有一个初始安装的功能，可能会有以下漏洞</p>\n</blockquote>\n<ul>\n<li>无验证功能，任意重装覆盖</li>\n<li>$_GET[‘step’]跳过限制步骤</li>\n<li>变量覆盖导致重装</li>\n<li>判断<code>lock</code>后跳转无<code>exit</code></li>\n<li>解析<code>install.php.bak</code>漏洞</li>\n<li>其他特定功能绕过漏洞</li>\n</ul>\n<p><img src=\"https://bj.bcebos.com/v1/image-langke/hexo-neirongpeitu/PHP代码审计/php_安装问题.png\" alt=\"\"></p>\n<h2 id=\"SQL数字型注入\"><a href=\"#SQL数字型注入\" class=\"headerlink\" title=\"SQL数字型注入\"></a>SQL数字型注入</h2><blockquote>\n<p>SQL攻击（SQL injection），简称注入攻击，是发生于应用程序之数据库层的安全漏洞</p>\n</blockquote>\n<blockquote>\n<p>SQL注入漏洞<br><img src=\"https://bj.bcebos.com/v1/image-langke/hexo-neirongpeitu/PHP代码审计/php_sql注入.png\" alt=\"\"></p>\n</blockquote>\n<blockquote>\n<p>思路展现<br><img src=\"https://bj.bcebos.com/v1/image-langke/hexo-neirongpeitu/PHP代码审计/php_sql_思路展现.png\" alt=\"\"></p>\n</blockquote>\n<h2 id=\"XSS后台敏感操作\"><a href=\"#XSS后台敏感操作\" class=\"headerlink\" title=\"XSS后台敏感操作\"></a>XSS后台敏感操作</h2><blockquote>\n<p>XSS是什么</p>\n</blockquote>\n<p>XSS表示Cross Site Scription（跨站脚本攻击），它主要是通过插入恶意脚本，实现对用户浏览器的控制</p>\n<blockquote>\n<p>XSS攻击可以分成两种类型</p>\n</blockquote>\n<ul>\n<li>非持久型攻击：是一次性的，仅对当次的页面访问产生影响。</li>\n<li>持久型攻击：会把攻击者的数据存储在服务器端，攻击行为将伴随着攻击数据一直存在。</li>\n</ul>\n<blockquote>\n<p>危害</p>\n</blockquote>\n<p>插入XSS攻击代码，以管理员身份执行敏感操作。</p>\n<blockquote>\n<p>思路展现</p>\n</blockquote>\n<p><img src=\"https://bj.bcebos.com/v1/image-langke/hexo-neirongpeitu/PHP代码审计/php_xss.png\" alt=\"\"></p>\n<h2 id=\"文件包含漏洞\"><a href=\"#文件包含漏洞\" class=\"headerlink\" title=\"文件包含漏洞\"></a>文件包含漏洞</h2><blockquote>\n<p>php上传思路</p>\n</blockquote>\n<p><img src=\"https://bj.bcebos.com/v1/image-langke/hexo-neirongpeitu/PHP代码审计/php_文件上传.png\" alt=\"\"></p>\n<blockquote>\n<p>绕过过程</p>\n</blockquote>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (<span class=\"keyword\">isset</span>($_GET[<span class=\"string\">'module'</span>]))&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">include</span>($_GET[<span class=\"string\">'module'</span>].<span class=\"string\">'.inc'</span>);</span><br><span class=\"line\">\t<span class=\"comment\">// phar://path/file/xx.inc</span></span><br><span class=\"line\">&#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">\t······</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这里可能存在一个文件包含漏洞，当然我们要先上传，你会知道，上传限制文件名后缀为图片。<br>过程如下：</p>\n<ul>\n<li>构造一个一句话文件，改名为<code>.inc</code></li>\n<li>把文件压缩，并改后缀名为<code>.png</code>。（phar://伪协议是打开一个压缩包，并打开里面的一个文件。）</li>\n<li>上传，构造伪协议包含，连菜刀。（上传后的文件名往往会被系统改为时间戳，而又不返回文件名，这时可以根据上传的时间来爆破）<br><img src=\"https://bj.bcebos.com/v1/image-langke/hexo-neirongpeitu/PHP代码审计/php_upload_时间戳.png\" alt=\"\"><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">date_default_timezone_set(<span class=\"string\">'UTC'</span>);</span><br><span class=\"line\"><span class=\"keyword\">echo</span> strtotime(<span class=\"string\">'抓包获取的时间'</span>)</span><br><span class=\"line\"><span class=\"comment\">// 把年月日转换为时间戳，工具时间戳上下爆破5，6个就可以猜测出来。</span></span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<blockquote>\n<p>思路展现</p>\n</blockquote>\n<p><img src=\"https://bj.bcebos.com/v1/image-langke/hexo-neirongpeitu/PHP代码审计/php_upload_思路展现.png\" alt=\"\"></p>\n<h2 id=\"任意文件读取\"><a href=\"#任意文件读取\" class=\"headerlink\" title=\"任意文件读取\"></a>任意文件读取</h2><ul>\n<li>任意文件读取时属于文件操作漏洞的一种</li>\n<li>一般任意文件读取漏洞可以读取配置信息，甚至系统重要文件</li>\n<li>严重的话，可能导致SSRF,进而漫游内网。<br><img src=\"https://bj.bcebos.com/v1/image-langke/hexo-neirongpeitu/PHP代码审计/php_read_.png\" alt=\"\"><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$query = <span class=\"string\">\"UPDATE users SET user_avater = '$avater' WHERE user_id = '&#123;$_SESSION['user_id']&#125;'\"</span>;</span><br><span class=\"line\"><span class=\"comment\">// 这里的user_avater = '$avater'可以写两个，数据库会取第二个有效值。</span></span><br><span class=\"line\">$query = <span class=\"string\">\"UPDATE users SET user_avater = '$avater',user_avater = '2' WHERE user_id = '&#123;$_SESSION['user_id']&#125;'\"</span>;</span><br><span class=\"line\"><span class=\"comment\">// 最终会更新为 2</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// payload ： ',user_avater = '../sys/conf.php' WHERE user_name = 'test'#.png(../sys/conf.php需要十六进制编码)</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<blockquote>\n<p>思路展现</p>\n</blockquote>\n<p><img src=\"https://bj.bcebos.com/v1/image-langke/hexo-neirongpeitu/PHP代码审计/php_read_思路展现.png\" alt=\"\"></p>\n<h2 id=\"越权问题\"><a href=\"#越权问题\" class=\"headerlink\" title=\"越权问题\"></a>越权问题</h2><ul>\n<li>越权问题并不复杂</li>\n<li>仅仅只是开发者的粗心大意</li>\n<li>没有严格控制账户体系</li>\n<li>导致可能操作（查看、修改、删除）其他用户的信息</li>\n</ul>\n<blockquote>\n<p>思路展现</p>\n</blockquote>\n<p><img src=\"https://bj.bcebos.com/v1/image-langke/hexo-neirongpeitu/PHP代码审计/php_越权_思路.png\" alt=\"\"></p>\n<blockquote>\n<p>修复</p>\n</blockquote>\n<p>比如：<br>更新用户名的时候，用<code>$_SESSION[&#39;user_id&#39;]</code>而不是用<code>POST[&#39;user&#39;]</code>获取的变量。</p>\n","categories":[],"tags":[{"name":"PHP代码审计","slug":"PHP代码审计","count":5,"path":"api/tags/PHP代码审计.json"}]}